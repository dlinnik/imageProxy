# Сервис Image Proxy

Прокси-сервис на TypeScript, который обрабатывает загрузку изображений из различных облачных хранилищ, включая Google Drive и Яндекс.Диск. Сервис предоставляет единый интерфейс для получения изображений с учетом особенностей каждого провайдера.

## Возможности

- Поддержка нескольких облачных хранилищ:
  - Google Drive
  - Яндекс.Диск (включая общие папки)
  - Прямые URL
- Автоматическая обработка и перенаправление URL
- Поддержка CORS
- Стриминговая отдача изображений для эффективного использования памяти

## Необходимые компоненты

- Node.js (14.x или выше)
- npm
- Docker (опционально, для контейнеризации)

## Установка

1. Клонируйте репозиторий
2. Установите зависимости:
   ```bash
   npm install
   ```
3. Соберите TypeScript-код:
   ```bash
   npm run build
   ```

## Использование

### Запуск сервера

Режим разработки (с авто-перезапуском):
```bash
npm run dev
```

Режим продакшн:
```bash
npm run build
npm start
```

С помощью Docker:
```bash
docker compose up
```

### API Эндпоинты

#### GET /

Проксирует запросы к изображениям от поддерживаемых провайдеров.

Параметры запроса:
- **`url` (обязательный)**: URL изображения для получения.
- **`width` (опциональный)**: минимальная ширина изображения, до которой нужно увеличить картинку.
- **`height` (опциональный)**: минимальная высота изображения, до которой нужно увеличить картинку.
- **`aspect` (опциональный)**: соотношение сторон, например `4:3` или `16:9`.  
  Если указано, то ширина или высота будут доведены до нужного размера.  
  При использовании `aspect` параметры `width` и `height` **обязательны**.
- **`frame` (опциональный)**: URL изображения‑рамки.  
  Если задан `frame`, параметры `height`, `aspect` и `width` (для режима ресайза) **игнорируются**.  
  Вместо этого используются параметры `width` (для режима рамки), `left`, `top`:
  - **`width` (опциональный, в режиме рамки)**: ширина, до которой нужно ресайзить фото.  
    Если не указан, фото не изменяется в размере (сохраняет исходные пропорции).
  - **`left` (опциональный)**: горизонтальное смещение фото от верхнего левого угла рамки, в пикселях.  
    По умолчанию: `0`. Не может быть отрицательным.
  - **`top` (опциональный)**: вертикальное смещение фото от верхнего левого угла рамки, в пикселях.  
    По умолчанию: `0`. Не может быть отрицательным.
  
  Сервис:
  - загружает рамку и определяет её размер;
  - если указан `width`, пропорционально масштабирует основное изображение до этой ширины;
  - размещает фото на рамке в позиции `(left, top)`;
  - если фото выходит за границы рамки, увеличивает размер итогового изображения;
  - накладывает рамку **поверх** фото.

**Формат ответа:**
- При любом виде обработки (ресайз / рамка) сервис всегда возвращает изображение в формате **JPEG** (`Content-Type: image/jpeg`).
- Единственное исключение — когда не указаны ни `width`/`height`, ни `frame`: в этом случае изображение **просто проксируется без изменений** с исходным `Content-Type` и без перекодирования.

Примеры запросов:
```
# Google Drive
http://localhost:2920/?url=https://drive.google.com/file/d/YOUR_FILE_ID/view

# Яндекс.Диск
http://localhost:2920/?url=https://disk.yandex.ru/d/LuLr3JDmys3nAg/9999A2САМОРЕЗ3.9X25-40 (1500х2000).jpg
# with resizing
https://ipx.databird.ru?url=https://disk.yandex.ru/i/ES1RdRlVkzxiUQ&width=900&height=1200&aspect=4:3

# URL картинки
http://localhost:2920/?url=https://example.com/image.jpg
```

# Наложение рамки (фото шириной 400px, смещение 50px справа и 30px снизу)
http://localhost:2920/?url=https://example.com/image.jpg&frame=https://example.com/frame.png&width=400&left=50&top=30

# Наложение рамки без ресайза фото (сохранит исходный размер)
http://localhost:2920/?url=https://example.com/image.jpg&frame=https://example.com/frame.png&left=20&top=20
```

## Переменные окружения

- `PORT`: Порт сервера (по умолчанию: 2920)

## Разработка

Проект использует TypeScript со строгой типизацией. Исходный код находится в директории `src`, скомпилированный код — в `dist`.

Доступные npm-скрипты:
- `npm run build`: Компиляция TypeScript
- `npm run start`: Запуск сервера в продакшн-режиме
- `npm run dev`: Запуск сервера в режиме разработки с авто-перезапуском

## Поддержка Docker

В проекте реализована поддержка Docker для контейнеризации. Используйте `docker-compose up -d --build` для запуска сервиса в контейнере.

## Лицензия

GPL-3.0 License
